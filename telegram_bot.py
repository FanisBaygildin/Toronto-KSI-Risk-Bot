# -*- coding: utf-8 -*-
"""telegram_bot.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vyPPLE_QWFKWQtmMpbWrwhK11Ho_okVa
"""

from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler

from google_maps_route import get_routes
from weather_api import build_weather_row
from route_risk import predict_risk

# Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ConversationHandler
START_PC, END_PC, PERIOD = range(3)

user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° (Ð¿Ñ€Ð¸ "Ð¿Ñ€Ð¾Ð±ÑƒÐ¶Ð´ÐµÐ½Ð¸Ð¸" Ð½Ð° Render)
    await update.message.reply_text("â³ Please wait... bot is waking up ðŸ’¤")
    await update.message.reply_text("ðŸ“ Send postal code of the start point")
    return START_PC

async def receive_start_pc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data['start'] = update.message.text.strip()
    await update.message.reply_text("ðŸ“ Send postal code of the destination point")
    return END_PC

async def receive_end_pc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data['end'] = update.message.text.strip()

    # ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ð¼ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°
    keyboard = [["Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ 3â€¯Ñ‡", "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ 24â€¯Ñ‡"]]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
    await update.message.reply_text("â° ÐÐ° ÐºÐ°ÐºÐ¾Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´?", reply_markup=reply_markup)
    return PERIOD

async def receive_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    period = update.message.text.strip()
    start = user_data['start']
    end = user_data['end']

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°
    route = get_routes(start, end)

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð³Ð¾Ð´Ñ‹
    weather = build_weather_row()  # Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ð¾Ð³Ð¾Ð´Ð° (Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ Ð¿Ð¾Ð´ Ð¿ÐµÑ€Ð¸Ð¾Ð´)

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€Ð¸ÑÐºÐ°
    risk, city_avg = predict_risk(route, weather, period)  # Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€Ð¸ÑÐº Ð¸ ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¾Ð´Ñƒ

    diff_percent = int(round((risk - city_avg) / city_avg * 100))

    if diff_percent > 0:
        comparison = f"higher than the city average by {diff_percent}%"
    elif diff_percent < 0:
        comparison = f"lower than the city average by {abs(diff_percent)}%"
    else:
        comparison = "equal to the city average"

    await update.message.reply_text(f"ðŸš§ KSI Risk: {risk:.2f}â€° ({comparison})")

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.")
    return ConversationHandler.END

def start_bot():
    import os

    TOKEN = os.getenv("BOT_TOKEN")  # Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    application = ApplicationBuilder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            START_PC: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_start_pc)],
            END_PC: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_end_pc)],
            PERIOD: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_period)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(conv_handler)
    print("Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½...")
    application.run_polling()
