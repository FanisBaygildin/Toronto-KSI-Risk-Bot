# -*- coding: utf-8 -*-
"""route_risk.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12E_6Z6sL-n0DyCY4DViaX7fDmS9zbutc
"""

import joblib
import os
import numpy as np
from model import ProbSumModel

# –ó–∞–≥—Ä—É–∑–∏ –º–æ–¥–µ–ª—å –æ–¥–∏–Ω —Ä–∞–∑
model = joblib.load("model/model.pkl")

def predict_risk(route_coords, weather_row, period):
    """
    route_coords: —Å–ø–∏—Å–æ–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç [(lat, lon), ...]
    weather_row: pd.Series —Å –ø–æ–≥–æ–¥–æ–π
    period: —Å—Ç—Ä–æ–∫–∞ "–°–ª–µ–¥—É—é—â–∏–µ 3‚ÄØ—á" –∏–ª–∏ "–°–ª–µ–¥—É—é—â–∏–µ 24‚ÄØ—á"

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (risk: float, city_avg: float)
    """
    # üî∏ –ù–∞–ø—Ä–∏–º–µ—Ä: —Å—á–∏—Ç–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ geohash –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
    import pygeohash as pgh
    geo_set = sorted({pgh.encode(lat, lon, precision=5) for lat, lon in route_coords})

    # üî∏ –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏
    features = weather_row.copy()
    features["GeoCount"] = len(geo_set)
    features["Period"] = 3 if "3" in period else 24

    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ DataFrame —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
    import pandas as pd
    X = pd.DataFrame([features])

    # üî∏ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    prob = model.predict_proba(X)[0, 1]  # –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∞ 1

    # üî∏ –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –≥–æ—Ä–æ–¥—É (–∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –ø–æ–∫–∞)
    city_avg = 0.28  # –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

    return prob, city_avg
